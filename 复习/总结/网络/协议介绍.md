# 协议介绍



## ISO七层协议和tcp/ip四层网络模型

### ISO七层网络协议

1. 物理层
2. 数据链路层
3. 网络层
4. 传输层
5. 会话层
6. 表示层
7. 应用层



### TCP/IP四层网络协议

1. 网络接口层（Ethernet）
2. 网络层（IP，ARP，ICMP）
3. 传输层（TCP，UDP）
4. 应用层（HTTP，FTP，TELNET，DHCP，DNS）

<img src="/复习/总结/网络/.assert/协议介绍/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATCBKaWF3ZW4=,size_20,color_FFFFFF,t_70,g_se,x_16.png" alt="计算机网络体系结构" style="zoom: 67%;" />

<img src="/复习/总结/网络/.assert/协议介绍/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBATCBKaWF3ZW4=,size_20,color_FFFFFF,t_70,g_se,x_16-20230422151118184.png" alt="TCP/IP模型 & OSI模型" style="zoom:67%;" />

## 以太网帧

以太网每个帧的大小为64~1518字节，每个帧的前后分别有14和4字节的信息，所有每帧携带的数据长度为46~1500字节。（有些系统支持**更大的帧**，最大可以支持 9000 字节。有些系统支持更大的帧，最大可以支持 9000 字节。）



<img src="/复习/总结/网络/.assert/协议介绍/image-20230422154943084.png" alt="image-20230422154943084" style="zoom:50%;" />

1. 前导码：调整时钟，使目的主机接收器时钟与源主机发送器时钟同步。由二进制10交替组成。
2. 帧首定界符：标志着从帧首定界符以后的数据都是以太网帧的数据，前6bit是二进制的1和0的交替组成，最后两位是11。
3. 目的MAC地址：下一跳的接口MAC地址
4. 源MAC地址：本机发送报文的物理接口的地址
5. 类型：用于告知上层解析时，使用什么协议解析，解封是可以根据类型知道对应的协议是什么协议。
6. 网络层数据：上层的数据，在数据链路层里网络层数据是不可见的，统称为数据。数据的最小长度必须为46字节以保证帧长至少为64字节，最大长度为1500字节。
7. 帧校验和：一种错误检测机制，计算目的mac、源mac、类型、网络层数据，得出循环冗余校验码(CRC)，将计算出的循环冗余校验码(CRC)填入帧校验和(FCS)里。



## IP协议

IP协议可以通过IP实现两台计算机之间的通信，如果是跨网络访问，需要通过路由器转发报文。

### 报文格式

https://juejin.cn/post/7053844340392591391

#### IPV4

<img src="/复习/总结/网络/.assert/协议介绍/image-20230422161146190.png" alt="image-20230422161146190" style="zoom:50%;" />

**版本**

4表示ipv4，6表示ipv6

![image-20220116233823644](/复习/总结/网络/.assert/协议介绍/83f0c0676a984980840558c0673597f9~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.png)

**首部长度**

4位，数值*4字节。当没有扩展字段时，TCP首部长度为20字节，首部长度为20/4=5

**服务类型**

用来表示服务的质量。可划分为 DSCP 和 ECN，DSCP 用来进行质量控制，ECN 用来报告网络拥堵情况。



**总长度**

标识头部和数据的总长度，最大为65535字节

**标识**

每个ip报文有一个唯一标识，同意ip报文的不同分片具有相同的标识。



**标志**

由3位表示。

![image-20220116235415313](/复习/总结/网络/.assert/协议介绍/36b45c9bb8864d95ac99466505ee7a01~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.png)

**偏移量**

标识当前分片在整个报文中的偏移量

偏移量=数值*8

**生存时间**（TTL）

每经过一个路由器，生存时间将会减一，当生存时间为0时，报文将会被丢弃



**协议**

标识IP协议的上层协议，例如TCP，UDP

**首部校验**

该字段只会校验数据包的首部，不会去校验数据部分。这个字段主要目的是用来确保 IP 数据包不被破坏。

**扩展头部**

通常用于实验和诊断



#### IPV6

![img](/复习/总结/网络/.assert/协议介绍/dd31fb0458934b839a28930c16ed9b08~tplv-k3u1fbpfcp-zoom-1.png)



## TCP协议

TCP时面向连接，可靠的数据流传输协议



### 报文格式

<img src="/复习/总结/网络/.assert/协议介绍/image-20230422165737116.png" alt="image-20230422165737116" style="zoom:50%;" />



**头部长度**

头部长度=数值*4。因此TCP头部长度范围为20~60



**标志位**

ack，sync，fin，rst，

urg表示的是此报文段中有紧急数据，将紧急数据排在普通数据的前面；当接受端收到此报文后后必须先处理紧急数据，而后再处理普通数据。

push当发送端将 PSH 置为1时，TCP会立即创建一个报文并发送。接受端收到 PSH 为1的报文后就立即将接受缓冲区内数据向上交付给应用程序，而不是等待缓冲区满后再交付。

**窗口大小**

由接收端发送给发送端，用于控制发送窗口大小。最大值为65535，但是结合扩展字段中的窗口缩放，可以指定更大的窗口大小。



**序列号**

表示当前报文中第一个数据在整个数据的位置。在连接时，会随机初始化一个序列号，当序列号达到最大值时，会从0开始计算。



**ACK**

表示下一个向接收的数据位置。比如已经接收到1000位置的数据，那么ack为10001



**校验和**

用于校验数据头和数据是否损坏



**紧急指针**

它和序列号相加得到紧急数据的下一个位置。用于发送紧急数据。



### 连接和挥手

主动断开的一方有time_wait状态，等待时间为2MSL。RFC793定义了MSL为2分钟，Linux设置成了30s。等待是为了将双方的包都失效。

<img src="/复习/总结/网络/.assert/协议介绍/5293f40a86cc4ff8a94d98ca242cd9f5~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.png" alt="img" style="zoom:67%;" />

### 可靠机制



#### 确认机制和重传

数据接收方会发送ack确定数据收到，如果发送方没有收到数据的ack，将会重新发送数据，以确保接收方收到数据

#### 慢启动和拥塞避免

为避免网络的拥塞，tcp在发送数据时，会从窗口为1MSS开始发送数据，当收到对应的ack后，会以指数形式增大窗口大小，直到达到阈值ssthresh，该阶段为慢启动。达到阈值后，窗口速度会以线性增加，直到出现丢包，该阶段称为拥塞避免。

#### 超时重传和快速重传

https://blog.csdn.net/weixin_43772166/article/details/91128620

当一个报文长事件没有ack，此时会触发超时重传，超时重传会将窗口调整为1，阈值调整为当前窗口的一半，重新开始慢启动。



当连续收到3个相同的ack，此时会进入快速重传和快速恢复阶段，窗口变成当前窗口一半，ssthresh也变成当前窗口一半，然后开始拥塞避免，线性增加窗口大小。

<img src="/复习/总结/网络/.assert/协议介绍/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzc3MjE2Ng==,size_16,color_FFFFFF,t_70.png" alt="在这里插入图片描述" style="zoom:67%;" />



### 其他

#### SACK

SACK为选择确认。在握手阶段，在扩展头部中可以增加SACK支持情况，如果支持，在确认报文中的扩展头部会携带已经收到的数据范围。方便发送端重传数据，避免重复发送。

https://www.cnblogs.com/tunian/p/9455381.html

#### Nagle算法

为了减少网络中的包，发送端只允许一个发送但是没有确认的**小分组包**。

1. 如果发送的数据没有达到MSS，将不会发送数据，直到接收到上一个包的ack
2. 如果发送的数据达到了MSS，将会直接发出，不等待上一个包的ack

**设置TCP_NODELAY参数**，可以解决关闭nagle算法

#### 延时ack

同样避免发送没有数据的ack包，接收端接收到数据时，但是有没有数据需要发送到对端，将会等待一段时间，如果依然没有数据，将会直接发送ack。



## UDP协议



### 报文格式

<img src="/复习/总结/网络/.assert/协议介绍/image-20230422193806678.png" alt="image-20230422193806678" style="zoom:50%;" />



## HTTP协议







## TLS和SSL





