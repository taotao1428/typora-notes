# jni学习



jni可以c++/c实现方法，并且让java直接调用。





## 书写一个包含native方法的类

```java
package com.hewutao;

public class MyLib {
    public native int add(int a, int b);
}

```



## 生成库头文件

### javah生成头文件

1. 将MyLib类编译成class文件
2. 进入target/classes文件夹中，执行下面命令。会生成一个头文件



```
javah -cp . com.hewutao.MyLib
```

<img src="/java虚拟机/.assert/jni/image-20230820205108163.png" alt="image-20230820205108163" style="zoom:50%;" />



com_hewutao_MyLib.h文件内容如下

```c++
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_hewutao_MyLib */

#ifndef _Included_com_hewutao_MyLib
#define _Included_com_hewutao_MyLib
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     com_hewutao_MyLib
 * Method:    add
 * Signature: (II)I
 */
JNIEXPORT jint JNICALL Java_com_hewutao_MyLib_add
  (JNIEnv *, jobject, jint, jint);

#ifdef __cplusplus
}
#endif
#endif
```



## 实现和编译native方法

### 创建工程

创建另外一个工程native-add2，在`java/c`目录下粘贴上面生成的com_hewutao_MyLib.h头文件，并创建com_hewutao_MyLib.cpp文件

```c++
#include <jni.h>
#include <stdio.h>
#include "com_hewutao_MyLib.h"

extern "C" {

JNIEXPORT jint JNICALL Java_com_hewutao_MyLib_add(JNIEnv *env, jobject obj, jint a, jint b) {
    return a + b;
}

}
```



### 配置pom文件

为了实现编译自动化，使用maven-hawtjni-plugin插件自动编译

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.hewutao</groupId>
        <artifactId>native-test</artifactId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>native-add2</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <!-- 指定c++源文件地址 -->
        <nativeSourceDirectory>${project.basedir}/src/main/c</nativeSourceDirectory>
    </properties>

    <build>
        <plugins>
            <plugin>
                <groupId>org.fusesource.hawtjni</groupId>
                <artifactId>maven-hawtjni-plugin</artifactId>
                <version>1.14</version>
                <executions>
                    <execution>
                        <id>build-native-lib</id>
                        <configuration>
                            <!-- 编译后so文件的名称 -->
                            <name>native-mylib</name>
                            <nativeSourceDirectory>${nativeSourceDirectory}</nativeSourceDirectory>
                            <libDirectory>${project.build.outputDirectory}</libDirectory>
                            <!-- We use Maven's artifact classifier instead.
                                 This hack will make the hawtjni plugin to put the native library
                                 under 'META-INF/native' rather than 'META-INF/native/${platform}'. -->
                            <platform>.</platform>
                        </configuration>
                        <goals>
                            <goal>generate</goal>
                            <goal>build</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
```



### 编译c++文件

执行下面maven命令，将会编译c++文件为so文件，并且将so文件打包进jar包中。

```shell
mvn clean package
```



<img src="/java虚拟机/.assert/jni/image-20230820210340218.png" alt="image-20230820210340218" style="zoom:50%;" />



### 通过g++命令直接编译

上面介绍通过maven插件编译c++。另外如果简单的话，可以直接使用g++命令编译。

```shell
# 编译时，需要包含jdk种的头文件
g++ -shared -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/linux" -o mylib.dll mylib.cpp
```



## 使用so文件

使用so文件可以有两个途径

1. 直接将so文件内置到部署环境中，此时可以直接使用绝对路径进行加载，这种方式不易维护
2. 将so文件放入到jar包中。在需要加载so文件时，通过getResource获取so文件字节流，然后写入到一个临时文件中，再加载临时文件。这种方式虽然麻烦，但是方便维护so文件，可以通过管理jar包的方式管理so文件。可以参考netty-common中io.netty.util.internal.NativeLibraryLoader#load方法



为了演示方便，下面使用第一种途径

```java
package com.hewutao;

public class Main {
    static {
        System.load("/home/parallels/idea_projects/native-add2/target/classes/META-INF/native/libnative-mylib.so");
    }
    public static void main(String[] args) throws Exception {
        MyLib myLib = new MyLib();
        System.out.println(myLib.add(1, 1)); // 输出2
    }
}
```

